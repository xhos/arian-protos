syntax = "proto3";

package arian.v1;

import "arian/v1/account.proto";
import "arian/v1/enums.proto";
import "buf/validate/validate.proto";
import "google/protobuf/field_mask.proto";
import "google/protobuf/timestamp.proto";
import "google/type/money.proto";

service AccountService {
  rpc ListAccounts(ListAccountsRequest) returns (ListAccountsResponse);
  rpc GetAccount(GetAccountRequest) returns (GetAccountResponse);
  rpc CreateAccount(CreateAccountRequest) returns (CreateAccountResponse);
  rpc UpdateAccount(UpdateAccountRequest) returns (UpdateAccountResponse);
  rpc DeleteAccount(DeleteAccountRequest) returns (DeleteAccountResponse);
  rpc SetAccountAnchor(SetAccountAnchorRequest) returns (SetAccountAnchorResponse);
  rpc GetAccountBalance(GetAccountBalanceRequest) returns (GetAccountBalanceResponse);
  rpc GetAnchorBalance(GetAnchorBalanceRequest) returns (GetAnchorBalanceResponse);
  rpc GetAccountsCount(GetAccountsCountRequest) returns (GetAccountsCountResponse);
  rpc SyncAccountBalances(SyncAccountBalancesRequest) returns (SyncAccountBalancesResponse);
}

message ListAccountsRequest {
  string user_id = 1 [(buf.validate.field).string.uuid = true];
}

message ListAccountsResponse {
  repeated Account accounts = 1;
}

message GetAccountRequest {
  string user_id = 1 [(buf.validate.field).string.uuid = true];
  int64 id = 2 [(buf.validate.field).int64.gt = 0];
}

message GetAccountResponse {
  Account account = 1;
}

message CreateAccountRequest {
  string user_id = 1 [(buf.validate.field).string.uuid = true];
  string name = 2 [(buf.validate.field).string = {
    min_len: 1,
    max_len: 100
  }];
  string bank = 3 [(buf.validate.field).string = {
    min_len: 1,
    max_len: 100
  }];
  AccountType type = 4 [(buf.validate.field).enum.defined_only = true];
  optional string alias = 5 [(buf.validate.field).string = {
    min_len: 1,
    max_len: 50
  }];
  google.type.Money anchor_balance = 6;
  string main_currency = 7 [(buf.validate.field).string = {
    len: 3,
    pattern: "^[A-Z]{3}$"
  }];
  repeated string colors = 8 [(buf.validate.field).repeated = {
    items: {
      string: {
        len: 7,
        pattern: "^#[0-9a-fA-F]{6}$"
      }
    }
  }];
}

message CreateAccountResponse {
  Account account = 1;
}

message UpdateAccountRequest {
  string user_id = 1 [(buf.validate.field).string.uuid = true];
  int64 id = 2 [(buf.validate.field).int64.gt = 0];
  google.protobuf.FieldMask update_mask = 3;

  // fields that can be updated
  optional string name = 4 [(buf.validate.field).string = {
    min_len: 1,
    max_len: 100
  }];
  optional string bank = 5 [(buf.validate.field).string = {
    min_len: 1,
    max_len: 100
  }];
  optional AccountType account_type = 6 [(buf.validate.field).enum.defined_only = true];
  optional string alias = 7 [(buf.validate.field).string = {
    min_len: 1,
    max_len: 50
  }];
  optional google.protobuf.Timestamp anchor_date = 8;
  optional google.type.Money anchor_balance = 9;
  optional string main_currency = 10 [(buf.validate.field).string = {
    len: 3,
    pattern: "^[A-Z]{3}$"
  }];
  repeated string colors = 11 [(buf.validate.field).repeated = {
    min_items: 3,
    max_items: 3,
    items: {
      string: {
        len: 7,
        pattern: "^#[0-9a-fA-F]{6}$"
      }
    }
  }];
}

message UpdateAccountResponse {
  Account account = 1;
}

message DeleteAccountRequest {
  string user_id = 1 [(buf.validate.field).string.uuid = true];
  int64 id = 2 [(buf.validate.field).int64.gt = 0];
}

message DeleteAccountResponse {
  int64 affected_rows = 1;
}

message SetAccountAnchorRequest {
  int64 id = 1 [(buf.validate.field).int64.gt = 0];
  google.type.Money balance = 2;
}

message SetAccountAnchorResponse {
  int64 affected_rows = 1;
}

message GetAccountBalanceRequest {
  int64 id = 1 [(buf.validate.field).int64.gt = 0];
}

message GetAccountBalanceResponse {
  google.type.Money balance = 1;
}

message GetAccountsCountRequest {
  string user_id = 1 [(buf.validate.field).string.uuid = true];
}

message GetAccountsCountResponse {
  int64 count = 1;
}

message SyncAccountBalancesRequest {
  int64 account_id = 1 [(buf.validate.field).int64.gt = 0];
}

message SyncAccountBalancesResponse {}

message GetAnchorBalanceRequest {
  int64 id = 1 [(buf.validate.field).int64.gt = 0];
}

message GetAnchorBalanceResponse {
  google.type.Money anchor_balance = 1;
  string currency = 2 [(buf.validate.field).string = {
    len: 3,
    pattern: "^[A-Z]{3}$"
  }];
}

